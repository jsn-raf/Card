<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Quick Notes</title>

  <link rel="manifest" href="/Notes/manifest.webmanifest">
  <meta name="theme-color" content="#f5f6f7">
  <meta name="mobile-web-app-capable" content="yes">

  <style>
    body { font-family: 'Segoe UI', Roboto, sans-serif; margin:0; background:#fff; color:#202124; }
    .toolbar {
      background:#f5f6f7; padding:15px; display:flex; align-items:center;
      border-bottom:1px solid #e3e5e7; height:50px; position:relative;
    }
    .back-arrow { font-size:20px; color:#5f6368; cursor:pointer; user-select:none; -webkit-tap-highlight-color:transparent; }
    .title { font-weight:500; margin-left:20px; user-select:none; -webkit-tap-highlight-color:transparent; }
    .action {
      position:absolute; right:8px; top:50%; transform:translateY(-50%);
      width:44px; height:44px; display:flex; align-items:center; justify-content:center;
      font-size:20px; color:#5f6368; cursor:pointer; user-select:none;
      -webkit-tap-highlight-color:transparent;
    }

    .wrap { padding:16px; }
    textarea {
      width:100%; min-height:calc(100vh - 170px);
      font-size:18px; line-height:1.6; border:none; outline:none; resize:none;
      caret-color:#202124;
    }

    .panel {
      margin:12px 0 0 0;
      padding:10px 12px;
      border:1px solid #e3e5e7;
      border-radius:8px;
      background:#fff;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
      font-size:14px;
      display:none;
      white-space:pre-wrap;
    }
    .muted { color:#5f6368; font-family:inherit; font-size:12px; }
  </style>
</head>

<body>
  <div class="toolbar">
    <span class="back-arrow" id="resetBtn">←</span>
    <span class="title">Quick Notes</span>
    <div class="action" id="runBtn" aria-label="Run">⋮</div>
  </div>

  <div class="wrap">
    <div class="muted">Line 1: card (eg AS / ace of spades). Line 2: position 1–52. Optional line 3: bottom card.</div>
    <div id="result" class="panel"></div>
    <textarea id="noteContent" placeholder="Tap to write..."></textarea>
  </div>

  <script>
    const stack = [
      "4C","2H","7D","3C","4H","6D","AS","5H","9S","2S","QH","3D",
      "QC","8H","6S","5S","9H","KC","2D","JH","3S","8S","6H","10C",
      "5D","KD","2C","3H","8D","5C","KS","JD","8C","10S","KH","JC",
      "7S","10H","AD","4S","7H","4D","AC","9C","JS","QD","7C","QS",
      "10D","6C","AH","9D"
    ];

    const noteContent = document.getElementById("noteContent");
    const result = document.getElementById("result");
    const runBtn = document.getElementById("runBtn");
    const resetBtn = document.getElementById("resetBtn");

    function parseFirstInt(s) {
      const m = String(s ?? "").match(/-?\d+/);
      return m ? parseInt(m[0], 10) : NaN;
    }

    function require1to52(n) {
      if (!Number.isFinite(n)) return NaN;
      if (n < 1 || n > 52) return NaN;
      return n;
    }

    function normaliseCard(input) {
      if (!input) return null;
      const raw = input.toUpperCase().trim();
      const compact = raw.replace(/\s+/g, "");
      if (/^(10|[2-9AJQK])[CDHS]$/.test(compact)) return compact;

      const sym = compact
        .replaceAll("♠","S").replaceAll("♥","H")
        .replaceAll("♦","D").replaceAll("♣","C");
      if (/^(10|[2-9AJQK])[CDHS]$/.test(sym)) return sym;

      const text = raw.replace(/[^A-Z0-9 ]/g, " ").replace(/\s+/g, " ").trim();
      const tokens = text.split(" ").filter(t => t && t !== "OF" && t !== "THE");

      const rankMap = {
        "ACE":"A","KING":"K","QUEEN":"Q","JACK":"J",
        "TEN":"10","NINE":"9","EIGHT":"8","SEVEN":"7",
        "SIX":"6","FIVE":"5","FOUR":"4","THREE":"3","TWO":"2",
        "A":"A","K":"K","Q":"Q","J":"J"
      };
      const suitMap = { "SPADES":"S","HEARTS":"H","DIAMONDS":"D","CLUBS":"C","S":"S","H":"H","D":"D","C":"C" };

      let rank = null, suit = null;
      for (const t of tokens) {
        if (!rank && (rankMap[t] || /^(10|[2-9])$/.test(t))) rank = rankMap[t] || t;
        if (!suit && suitMap[t]) suit = suitMap[t];
      }
      return (rank && suit) ? rank + suit : null;
    }

    function positionAfterCut(originalPos, bottomPos) {
      const z = (originalPos - bottomPos - 1) % 52;
      return (z < 0 ? z + 52 : z) + 1;
    }

    function show(msg) {
      result.textContent = msg;
      result.style.display = "block";
    }

    function hide() {
      result.textContent = "";
      result.style.display = "none";
    }

    function run() {
      const lines = noteContent.value.split("\n").map(l => l.trim()).filter(Boolean);
      if (lines.length < 2) { show("Need at least 2 lines."); return; }

      const namedCard = normaliseCard(lines[0]);
      const targetPos = require1to52(parseFirstInt(lines[1]));
      if (!namedCard) { show("Line 1 card not recognised."); return; }
      if (isNaN(targetPos)) { show("Line 2 must be a number 1–52."); return; }

      let bottomCard = null;
      if (lines.length >= 3) {
        bottomCard = normaliseCard(lines[2]);
        if (!bottomCard) { show("Line 3 (bottom card) not recognised."); return; }
      }

      let currentPos;
      if (bottomCard) {
        const bottomPos = stack.indexOf(bottomCard) + 1;
        const origPos = stack.indexOf(namedCard) + 1;
        if (bottomPos <= 0) { show("Bottom card not in stack."); return; }
        if (origPos <= 0) { show("Named card not in stack."); return; }
        currentPos = positionAfterCut(origPos, bottomPos);
      } else {
        currentPos = stack.indexOf(namedCard) + 1;
        if (currentPos <= 0) { show("Named card not in stack."); return; }
      }

      const diff = currentPos - targetPos;

      if (diff === 0) {
        show(`MATCH\nCard: ${namedCard}\nPosition: ${targetPos}`);
        return;
      }

      let shift = diff % 52;
      if (shift < 0) shift += 52;

      const out = stack[shift - 1];
      show(`RESULT\nOutput card: ${out}\nShift: ${shift}\nFrom: ${namedCard} @ ${currentPos}\nTo: ${targetPos}`);
    }

    runBtn.addEventListener("click", run);
    resetBtn.addEventListener("click", () => { noteContent.value = ""; hide(); });

    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("/Notes/sw.js").catch(() => {});
    }
  </script>
</body>
</html>
